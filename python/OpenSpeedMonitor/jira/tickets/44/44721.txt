Migrations-Skript DB für Device-übergreifenden CSI	"Die Änderungen am Datenmodell werden nicht alle automatisch durch GORM durchgeführt.



Die folgenden manuellen Änderungen sind erforderlich:

*Job*

{code}

# osm - job #########################################################################

# grouped selection of connectivity settings

select count(id),cast(no_traffic_shaping_at_all as unsigned) as not_at_all,cast(custom_connectivity_profile as unsigned) as custom_conn,connectivity_profile_id,custom_connectivity_name,bandwidth_down,bandwidth_up,latency,packet_loss 

from job 

group by no_traffic_shaping_at_all,custom_connectivity_profile,connectivity_profile_id,custom_connectivity_name,bandwidth_down,bandwidth_up,latency,packet_loss;

# selection and update of predefined profile jobs with custom settings (bandwidth, latency, ...) - these get nulled

select cast(no_traffic_shaping_at_all as unsigned) as not_at_all,cast(custom_connectivity_profile as unsigned) as custom_conn,connectivity_profile_id,custom_connectivity_name,bandwidth_down,bandwidth_up,latency,packet_loss 

	from job 

	where connectivity_profile_id is not null;

update job 

	set bandwidth_down=null,bandwidth_up=null,latency=null,packet_loss=null 

	where connectivity_profile_id is not null;

# selection and update of jobs without predefined profile and without custom settings (bandwidth, latency, ...) - these become native connectivities

select id,label,cast(no_traffic_shaping_at_all as unsigned) as not_at_all,cast(custom_connectivity_profile as unsigned) as custom_conn,connectivity_profile_id,custom_connectivity_name,bandwidth_down,bandwidth_up,latency,packet_loss 

	from job 

	where connectivity_profile_id is null and bandwidth_down is null;

update job set no_traffic_shaping_at_all=1 

	where connectivity_profile_id is null and bandwidth_down is null;



update job set custom_connectivity_name = 'Custom' where cast(custom_connectivity_profile as unsigned) = 1;

# selection and update of custom conn jobs without custom conn name - default custom conn name is set

select id,label,concat('Custom (',bandwidth_down,'/',bandwidth_up,' Kbps, ',latency,'ms, ',packet_loss,'% PLR)'),cast(no_traffic_shaping_at_all as unsigned) as not_at_all,cast(custom_connectivity_profile as unsigned) as custom_conn,connectivity_profile_id,custom_connectivity_name,bandwidth_down,bandwidth_up,latency,packet_loss 

	from job 

	where connectivity_profile_id is null and custom_connectivity_name is null and cast(no_traffic_shaping_at_all as unsigned)=0;

update job set custom_connectivity_name=concat('Custom (',bandwidth_down,'/',bandwidth_up,' Kbps, ',latency,'ms, ',packet_loss,'% PLR)')

	where connectivity_profile_id is null and custom_connectivity_name is null and cast(no_traffic_shaping_at_all as unsigned)=0;

{code}

*EventResults*

{code}

# osm - event_result #########################################################################

# select and update event_results of jobs with associated connectivity_profile

select distinct(j.label)

from event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	where j.connectivity_profile_id is not null;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.connectivity_profile_id=j.connectivity_profile_id

	where j.connectivity_profile_id is not null;

# selection and update of event_results of jobs with native connectivity (no one in last month)

select distinct(j.label)

from event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	where cast(j.no_traffic_shaping_at_all as unsigned)=1;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.custom_connectivity_name='Native (No Traffic Shaping)'

	where cast(j.no_traffic_shaping_at_all as unsigned)=1;

# selection and update of event_results of jobs with custom connectivity

select distinct(j.label)

from event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	where j.connectivity_profile_id is null and cast(j.no_traffic_shaping_at_all as unsigned)=0;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.custom_connectivity_name=j.custom_connectivity_name

	where j.connectivity_profile_id is null and cast(j.no_traffic_shaping_at_all as unsigned)=0;

{code}

"		Task	OpenSpeedMonitor	23/Jun/15 11:45 AM	15/Jul/15 4:52 PM														"15/Jul/15 9:36 AM;nku;Nur Updates:



{code}

update job 

	set bandwidth_down=null,bandwidth_up=null,latency=null,packet_loss=null 

	where connectivity_profile_id is not null;

update job set no_traffic_shaping_at_all=1 

	where connectivity_profile_id is null and bandwidth_down is null;

update job set custom_connectivity_name = 'Custom' where cast(custom_connectivity_profile as unsigned) = 1;

update job set custom_connectivity_name=concat('Custom (',bandwidth_down,'/',bandwidth_up,' Kbps, ',latency,'ms, ',packet_loss,'% PLR)')

	where connectivity_profile_id is null and custom_connectivity_name is null and cast(no_traffic_shaping_at_all as unsigned)=0;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.connectivity_profile_id=j.connectivity_profile_id

	where j.connectivity_profile_id is not null;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.custom_connectivity_name='Native (No Traffic Shaping)'

	where cast(j.no_traffic_shaping_at_all as unsigned)=1;

update event_result er 

	inner join job_result jr on er.job_result_id=jr.id

	inner join job j on jr.job_id=j.id

	set er.custom_connectivity_name=j.custom_connectivity_name

	where j.connectivity_profile_id is null and cast(j.no_traffic_shaping_at_all as unsigned)=0;

{code}"																																																						
