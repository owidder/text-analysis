<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>

        circle.node {
            stroke-width: 1.5px;
            opacity: 0.7;
        }

    </style>
</head>
<body>
<div class="progress">
    <div id="progressbar" class="determinate" style="width: 0%"></div>
</div>
<input id="quantile-slider" value="0" type="range" min="0" max="50"/>
<div id="force"></div>
<script src="bower_components/bottlejs/dist/bottle.js"></script>
<script>var bottle = new Bottle();</script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/crypto-js/crypto-js.js"></script>

<script src="js/util/simplePromise.js"></script>
<script src="js/util/util.js"></script>
<script src="js/legend.js"></script>

<script src="bower_components/d3/d3.min.js"></script>
<script src="js/util/stuff.js"></script>
<link rel="stylesheet" type="text/css" href="bower_components/materialize/dist/css/materialize.css"
      media="screen,projection"/>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script>

    var PINCH_FACTOR = 7;

    var path = bottle.container.util.param("path", "");
    var Legend = bottle.container.Legend;

    var width = window.innerWidth;
    var height = window.innerHeight;

    var svg = d3.select("#force").append("svg")
        .attr("class", "force")
        .attr("width", width)
        .attr("height", height * 2);

    var gNodes = svg.append("g");
    var gTexts = svg.append("g");
    var gLegend = svg.append("g")
        .attr("class", "legend-layer");

    var legend = new Legend("svg.force", 1, gLegend);

    svg.on("click", function () {
            legend.switchLegend();
        })
        .on("mousemove", function () {
            var evt = d3.mouse(this);
            legend.mouseMoved(evt[0], evt[1]);
        })
        .on("mouseout", legend.hideLegend);

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function (d) {
            return d.name;
        }).distance(function (d) {
            return -d.value;
        }))
        .force("charge", d3.forceManyBody().strength(-10))
        .force("center", d3.forceCenter(width * PINCH_FACTOR/2, height * PINCH_FACTOR/2));

    function drawForce() {
        var zoomFactor = 1;

        var zoom = d3.zoom()
            .scaleExtent([1, 200])
            .on("zoom", function () {
                zoomed();
                zoomFactor = d3.event.transform.k;
                drawTexts();
            });

        svg.call(zoom);

        var textShown = false;

        var currentTransform = null;
        function zoomed() {
            currentTransform = d3.event.transform;
            gNodes.attr("transform", currentTransform);
            gTexts.attr("transform", currentTransform);
        }

        var nodes;
        var links;

        function drawNodes() {
            var selectionWithData = gNodes.selectAll("circle.node")
                .data(nodes, function (d) {
                    return d.name;
                });

            selectionWithData.enter()
                .append("circle")
                .attr("class", function (d) {
                    var classes = "node forlegend";
                    if(d.depth == 0) {
                        return classes + " root";
                    }
                    return classes;
                })
                .attr("r", 1)
                .attr("fill", function (d) {
                    var parts = d.name.split(".");
                    var type = parts[parts.length-1];
                    return color(type);
                })
                .attr("_legend", function (d) {
                    return d.name;
                })
                .call(stuff.drag);

            selectionWithData.exit().remove();
        }

        function drawTexts() {
            if(zoomFactor > 10) {
                textShown = true;
                var selectionWithData = gTexts.selectAll("text.node")
                    .data(nodes, function (d) {
                        return d.name;
                    });

                selectionWithData.enter()
                    .append("text")
                    .attr("class", "node")
                    .text(function (d) {
                        return d.shortName;
                    });

                selectionWithData.exit().remove();

                updateText();
            }
            else {
                textShown = false;
                gTexts.selectAll("text.node").data([]).exit().remove();
            }
        }

        function updateText() {
            if(textShown) {
                gTexts.selectAll("text.node")
                    .attr("x", function (d) {
                        return d.x / PINCH_FACTOR;
                    })
                    .attr("y", function (d) {
                        return d.y / PINCH_FACTOR;
                    })
                    .attr("style", function () {
                        return "font-size: " + (.4 / zoomFactor) + "em;";
                    })
            }
        }

        function ticked() {
            gNodes.selectAll("circle.node")
                .attr("cx", function (d) {
                    return d.x / PINCH_FACTOR;
                })
                .attr("cy", function (d) {
                    return d.y / PINCH_FACTOR;
                });

            updateText();
        }

        function startForce() {
            simulation.nodes(nodes);

            simulation.force("link")
                .links(links);

            simulation.alpha(1).restart();

            var ctr = 0;
            var MAX_CTR = 20;
            var interval = setInterval(function () {
                ctr++;
                if(ctr > MAX_CTR) {
                    clearInterval(interval);
                    simulation.stop();
                }
                else {
                    document.getElementById("progressbar").style = "width: " + (ctr/MAX_CTR*100) + "%";
                }
                ticked();
            }, 1000);
        }

        var threshold = document.getElementById("quantile-slider").value;

        d3.json('/api/theWholeCloud/50', function (error, data) {
            nodes = data.nodes;
            links = data.links;
            drawNodes();
            startForce();
        });
    }

    legend.appendLegend();
    drawForce();

</script>
</body>
</html>
