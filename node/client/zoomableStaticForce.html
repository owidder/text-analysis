<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>

        circle.node {
            stroke-width: 1.5px;
            opacity: 0.7;
        }

        #birdsview svg {
            border-style: solid;
            border-color: gray;
        }

        div.container {
            width:100%;
            margin: 0%;
        }

    </style>
</head>
<body>
<script src="bower_components/bottlejs/dist/bottle.js"></script>
<script>var bottle = new Bottle();</script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/crypto-js/crypto-js.js"></script>

<script src="js/util/simplePromise.js"></script>
<script src="js/util/util.js"></script>

<script src="bower_components/d3/d3.min.js"></script>
<script src="js/util/stuff.js"></script>
<link rel="stylesheet" type="text/css" href="bower_components/materialize/dist/css/materialize.css"
      media="screen,projection"/>
<link rel="stylesheet" type="text/css" href="css/style.css">

<div class="">
    <div class="row">
        <div class="col s12">
            <div class="progress">
                <div id="progressbar" class="determinate" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <input id="quantile-slider" value="0" type="range" min="0" max="50"/>
        </div>
    </div>
    <div class="row">
        <div class="col s3">
            <div id="birdsview"></div>
        </div>
        <div class="col s9">
            <div id="zoom"></div>
        </div>
    </div>
</div>

<script>

    var PINCH_FACTOR = 12;

    var path = bottle.container.util.param("path", "");

    var birdviewWidth = window.innerWidth/4.3;
    var birdsviewHeight = window.innerHeight/4.3;

    var width = birdviewWidth*3;
    var height = birdsviewHeight*3;

    var birdviewSvg = d3.select("#birdsview").append("svg")
        .attr("class", "force")
        .attr("width", birdviewWidth+20)
        .attr("height", birdsviewHeight+20);

    var zoomSvg = d3.select("#zoom").append("svg")
        .attr("class", "zoom")
        .attr("width", width)
        .attr("height", height);

    var gNodes = birdviewSvg.append("g");

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    function getDimensions(nodes) {
        var minX = Number.MAX_VALUE;
        var minY = Number.MAX_VALUE;
        var maxX = -Number.MAX_VALUE;
        var maxY = -Number.MAX_VALUE;

        nodes.forEach(function (d) {
            if(d.x < minX) {
                minX = d.x;
            }
            if(d.y < minY) {
                minY = d.y;
            }
            if(d.x > maxX) {
                maxX = d.x;
            }
            if(d.y > maxY) {
                maxY = d.y;
            }
        });

        return {
            width: maxX - minX,
            height: maxY - minY,
            maxX: maxX,
            maxY: maxY,
            minX: minX,
            minY: minY
        }
    }

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function (d) {
            return d.name;
        }).distance(function (d) {
            return -d.value;
        }))
        .force("charge", d3.forceManyBody().strength(-10))
        .force("center", d3.forceCenter(birdviewWidth * PINCH_FACTOR/2, birdsviewHeight * PINCH_FACTOR/2));

    function drawForce() {
        var nodes;
        var links;

        function drawNodes() {
            var selectionWithData = gNodes.selectAll("circle.node")
                .data(nodes, function (d) {
                    return d.name;
                });

            selectionWithData.enter()
                .append("circle")
                .attr("class", function (d) {
                    var classes = "node forlegend";
                    if(d.depth == 0) {
                        return classes + " root";
                    }
                    return classes;
                })
                .attr("r", 1)
                .attr("fill", function (d) {
                    var parts = d.name.split(".");
                    var type = parts[parts.length-1];
                    return color(type);
                });

            selectionWithData.exit().remove();
        }

        function ticked() {
            var dimensions = getDimensions(nodes);
            var pinchX = birdviewWidth / dimensions.width;
            var pinchY = birdsviewHeight / dimensions.height;

            gNodes.selectAll("circle.node")
                .attr("cx", function (d) {
                    return (d.x - dimensions.minX) * pinchX + 10;
                })
                .attr("cy", function (d) {
                    return (d.y - dimensions.minY) * pinchY + 10;
                });
        }

        function startForce() {
            simulation.nodes(nodes);

            simulation.force("link")
                .links(links);

            simulation.alpha(1).restart();

            var ctr = 0;
            var MAX_CTR = 20;
            var interval = setInterval(function () {
                ctr++;
                if(ctr > MAX_CTR) {
                    clearInterval(interval);
                    simulation.stop();
                }
                else {
                    document.getElementById("progressbar").style = "width: " + (ctr/MAX_CTR*100) + "%";
                }
                ticked();
            }, 1000);
        }

        var threshold = document.getElementById("quantile-slider").value;

        d3.json('/api/theWholeCloud/70', function (error, data) {
            nodes = data.nodes;
            links = data.links;
            drawNodes();
            startForce();
        });
    }

    drawForce();

</script>
</body>
</html>
