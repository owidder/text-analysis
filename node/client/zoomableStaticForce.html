<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>

        circle.node {
            stroke-width: 1.5px;
            opacity: 0.7;
        }

        #birdsview svg {
            border-style: solid;
            border-color: gray;
        }

        div.container {
            width:100%;
            margin: 0%;
        }

        .viewfinder {
            opacity: 0;
        }

    </style>
</head>
<body>
<script src="bower_components/bottlejs/dist/bottle.js"></script>
<script>var bottle = new Bottle();</script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/crypto-js/crypto-js.js"></script>

<script src="js/util/simplePromise.js"></script>
<script src="js/util/util.js"></script>
<script src="js/util/svgUtil.js"></script>

<script src="bower_components/d3/d3.min.js"></script>
<script src="js/util/stuff.js"></script>
<link rel="stylesheet" type="text/css" href="bower_components/materialize/dist/css/materialize.css"
      media="screen,projection"/>
<link rel="stylesheet" type="text/css" href="css/style.css">

<div class="">
    <div class="row">
        <div class="col s12">
            <div class="progress">
                <div id="progressbar" class="determinate" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col s12">
            <input id="quantile-slider" value="0" type="range" min="0" max="50"/>
        </div>
    </div>
    <div class="row">
        <div class="col s3">
            <div id="birdsview"></div>
        </div>
        <div class="col s9">
            <div id="zoom"></div>
        </div>
    </div>
</div>

<script>

    var path = bottle.container.util.param("path", "");
    var svgUtil = bottle.container.svgUtil;

    var BIRDSVIEW_PINCH_FACTOR = 4.3;

    var birdviewWidth = window.innerWidth / BIRDSVIEW_PINCH_FACTOR;
    var birdsviewHeight = window.innerHeight / BIRDSVIEW_PINCH_FACTOR;

    var width = birdviewWidth*3;
    var height = birdsviewHeight*3;

    var zoomWidth = 15;
    var zoomHeight = 15;

    var zoomFactorX = (width / zoomWidth);
    var zoomFactorY = (height / zoomHeight);

    var birdviewSvg = d3.select("#birdsview").append("svg")
        .attr("class", "force")
        .attr("width", birdviewWidth+20)
        .attr("height", birdsviewHeight+20)
        .on("mousemove", function () {
            var evt = d3.mouse(this);
            zoom(evt[0], evt[1]);
        });

    var zoomSvg = d3.select("#zoom").append("svg")
        .attr("class", "zoom")
        .attr("width", width)
        .attr("height", height);

    var zoomSvgRect = zoomSvg.node().getBoundingClientRect();
    var zoomCenterX = zoomSvgRect.width/2;
    var zoomCenterY = zoomSvgRect.height/2;

    var birdsviewNodes = birdviewSvg.append("g");

    var zoomNodes = zoomSvg.append("g");
    var viewfinderrect = birdviewSvg.node().createSVGRect();

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    function getNodeList(x, y) {
        viewfinderrect.x = x - zoomWidth/2;
        viewfinderrect.y = y - zoomHeight/2;
        viewfinderrect.width = zoomWidth;
        viewfinderrect.height = zoomHeight;

        var circleList = birdviewSvg.node().getIntersectionList(viewfinderrect, null);
        var nodeList = [];
        circleList.forEach(function (circle) {
            return nodeList.push(circle.__data__);
        });

        return nodeList;
    }

    function zoom(x, y) {
        var nodeList = getNodeList(x, y);
        drawZoom(nodeList, x, y);
    }

    function getDimensions(nodes) {
        var minX = Number.MAX_VALUE;
        var minY = Number.MAX_VALUE;
        var maxX = -Number.MAX_VALUE;
        var maxY = -Number.MAX_VALUE;

        nodes.forEach(function (d) {
            if(d.x < minX) {
                minX = d.x;
            }
            if(d.y < minY) {
                minY = d.y;
            }
            if(d.x > maxX) {
                maxX = d.x;
            }
            if(d.y > maxY) {
                maxY = d.y;
            }
        });

        return {
            width: maxX - minX,
            height: maxY - minY,
            maxX: maxX,
            maxY: maxY,
            minX: minX,
            minY: minY
        }
    }

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function (d) {
            return d.name;
        }).distance(function (d) {
            return -d.value;
        }))
        .force("charge", d3.forceManyBody().strength(-10))
        .force("center", d3.forceCenter(birdviewWidth/2, birdsviewHeight/2));

    function colorForNodeName(name) {
        var parts = name.split(".");
        var type = parts[parts.length-1];
        return color(type);
    }

    function drawZoom(nodes, zoomX, zoomY) {
        var selectionWithData = zoomNodes.selectAll("circle.node")
            .data(nodes, function (d) {
                return d.name;
            });

        selectionWithData.enter()
            .append("circle")
            .attr("class", "node forlegend zoom")
            .attr("fill", function (d) {
                return colorForNodeName(d.name);
            });

        function zx(x) {
            var diffX = x - zoomX;
            var _zx = zoomCenterX + diffX*zoomFactorX;
            return _zx;
        }

        function zy(y) {
            var diffY = y - zoomY;
            var _zy = zoomCenterY + diffY*zoomFactorY;
            return _zy;
        }

        zoomNodes.selectAll("circle.node")
            .attr("r", zoomFactorX/2)
            .attr("cx", function (d) {
                return zx(d.pcx);
            })
            .attr("cy", function (d) {
                return zy(d.pcy);
            });

        selectionWithData.exit().remove();
    }

    function drawForce() {
        var nodes;
        var links;

        function drawNodes() {
            var selectionWithData = birdsviewNodes.selectAll("circle.node")
                .data(nodes, function (d) {
                    return d.name;
                });

            selectionWithData.enter()
                .append("circle")
                .attr("class", "node forlegend")
                .attr("r", 1)
                .attr("fill", function (d) {
                    return colorForNodeName(d.name);
                });

            selectionWithData.exit().remove();
        }

        function ticked() {
            var dimensions = getDimensions(nodes);
            var pinchX = birdviewWidth / dimensions.width;
            var pinchY = birdsviewHeight / dimensions.height;

            birdsviewNodes.selectAll("circle.node")
                .attr("cx", function (d) {
                    d.pcx = (d.x - dimensions.minX) * pinchX + 10;
                    return d.pcx;
                })
                .attr("cy", function (d) {
                    d.pcy = (d.y - dimensions.minY) * pinchY + 10;
                    return d.pcy;
                });
        }

        function startForce() {
            simulation.nodes(nodes);

            simulation.force("link")
                .links(links);

            simulation.alpha(1).restart();

            var ctr = 0;
            var MAX_CTR = 20;
            var interval = setInterval(function () {
                ctr++;
                if(ctr > MAX_CTR) {
                    clearInterval(interval);
                    simulation.stop();
                }
                else {
                    document.getElementById("progressbar").style = "width: " + (ctr/MAX_CTR*100) + "%";
                }
                ticked();
            }, 1000);
        }

        var threshold = document.getElementById("quantile-slider").value;

        d3.json('/api/theWholeCloud/70', function (error, data) {
            nodes = data.nodes;
            links = data.links;
            drawNodes();
            startForce();
        });
    }

    drawForce();

</script>
</body>
</html>
