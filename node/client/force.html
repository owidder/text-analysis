<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>

        line.travel {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        circle.city {
            stroke: #fff;
            stroke-width: 1.5px;
            opacity: 0.2;
        }

        text.city {
            font-size: .7em;
        }

    </style>
</head>
<body>
<input id="quantile-slider" type="range" min="0" max="1000" onchange="sliderChanged()"/>
<div id="force"></div>
<script src="bower_components/d3/d3.min.js"></script>
<script src="js/util/stuff.js"></script>
<link rel="stylesheet" type="text/css" href="bower_components/materialize/dist/css/materialize.css"
      media="screen,projection"/>
<script>

    var width = window.innerWidth;
    var height = window.innerHeight;

    var svg = d3.select("#force").append("svg")
            .attr("width", width)
            .attr("height", height);

    var gLinks = svg.append("g");
    var gTexts = svg.append("g");
    var gNodes = svg.append("g");

    var graph;

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function (d) {
                return d.name;
            }).distance(function (d) {
                return -d.count;
            }))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2));

    function sliderChanged() {
        var quantile = document.getElementById("quantile-slider").value;
        drawForce();
    }

    function drawForce() {
        if(graph == null) return;

        ///////////////////////////////////
        // WKS Start
        ///////////////////////////////////

        function drawLinks(links) {
            var selectionWithData = gLinks.selectAll("line.travel")
                    .data(links, function (d) {
                        return d.source + "#" + d.target;
                    });

            selectionWithData.enter()
                    .append("line")
                    .attr("class", "travel")
                    .style("stroke-width", function(d) {
                        return Math.sqrt(d.count / 50)
                    });

            selectionWithData.exit().remove();
        }

        function drawTexts(nodes) {
            var selectionWithData = gTexts.selectAll("text.city")
                    .data(nodes, function (d) {
                        return d.name;
                    });

            selectionWithData.enter()
                    .append("text")
                    .attr("class", "city")
                    .text(function (d) {
                        return d.kennzeichen;
                    });

            selectionWithData.exit().remove();
        }

        function drawNodes(nodes) {
            var selectionWithData = gNodes.selectAll("circle.city")
                    .data(nodes, function (d) {
                        return d.name;
                    });

            selectionWithData.enter()
                    .append("circle")
                    .attr("class", "city")
                    .attr("r", 10)
                    .attr("fill", function(d) {
                        return color(d.bundesland);
                    })
                    .call(stuff.drag)
                    .append("title")
                    .text(function (d) {
                        return d.name;
                    });

            selectionWithData.exit().remove();
        }

        function ticked() {
            gNodes.selectAll("circle.city")
                    .attr("cx", function(d) {
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    });

            gTexts.selectAll("text.city")
                    .attr("x", function(d) {
                        return d.x;
                    })
                    .attr("y", function (d) {
                        return d.y;
                    });

            gLinks.selectAll("line.travel")
                    .attr("x1", function (d) {
                        return d.source.x;
                    })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    })
        }

        ///////////////////////////////////
        // WKS End
        ///////////////////////////////////

        function startForce() {
            simulation
                    .nodes(graph.cities)
                    .on("tick", ticked);

            simulation.force("link")
                    .links(graph.links);

            simulation.alpha(1).restart();
        }

        var quantile = document.getElementById("quantile-slider").value;
        var threshold = stuff.valueQuantile(graph.links, (1000 - Number(quantile)) / 1000, "count");
        console.log("quantile: " + (1000 - Number(quantile)) / 1000);
        console.log("threshold: " + threshold);

        var filteredLinks = graph.links
                .filter(function (d) {
                    return d.count >= threshold;
                });

        var filteredNodes = stuff.filterNodesFromLinks(filteredLinks, graph.cities);

        drawNodes(filteredNodes);
        drawTexts(filteredNodes);
        drawLinks(filteredLinks);
        startForce();

    }

    d3.json("/api/matrix", function (error, data) {
        graph = data;
        drawForce();
    });
</script>
</body>
</html>
