<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF8">
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="ancient-lib/bower_components/d3/d3.min.js"></script>
    <script src="js/cloud.js"></script>
</head>
<body>
<div id="chart"></div>

<script src="bower_components/bottlejs/dist/bottle.js"></script>
<script>var bottle = new Bottle();</script>
<script src="bower_components/lodash/dist/lodash.js"></script>

<script src="js/util/simplePromise.js"></script>
<script src="js/util/util.js"></script>

<script>

    function drawWordCloud(word_count){

        var svg_location = "#chart";
        var width = $(document).width();
        var height = $(document).height();

        var fill = d3.scale.category20();

        var word_entries = d3.entries(word_count);

        var xScale = d3.scale.linear()
            .domain([0, d3.max(word_entries, function(d) {
                return d.value;
            })
            ])
            .range([10,100]);

        d3.layout.cloud().size([width, height])
            .timeInterval(20)
            .words(word_entries)
            .fontSize(function(d) {
                return xScale(+d.value);
            })
            .text(function(d) { return d.key; })
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            .font("Impact")
            .on("end", draw)
            .start();

        function draw(words) {
            d3.select(svg_location).append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + [width >> 1, height >> 1] + ")")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function(d) {
                    return xScale(d.value) + "px";
                })
                .style("font-family", "Impact")
                .style("fill", function(d, i) {
                    return fill(i);
                })
                .attr("text-anchor", "middle")
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) {
                    return d.key;
                })
                .append("title")
                .text(function (d, i) {
                    return "Rank: " + (i+1);
                });
        }

        d3.layout.cloud().stop();
    }

    var currentFolder = bottle.container.util.param("folder", ".");

    d3.json("http://localhost:3000/api/values/2/" + currentFolder, function(error, words) {
        drawWordCloud(words);
    });

</script>
</body>
</html>